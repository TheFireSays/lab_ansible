---
- name: Generate NX-OS config files via template
  hosts: data_switches
  tasks:
    - name: Generate config from template
      template:
        src: "{{ playbook_dir }}/../templates/data_switches_template.j2"
        dest: "{{ playbook_dir }}/../configs/{{ inventory_hostname }}.cfg"
      register: template_result
      
    - name: Get current timestamp
      command: date -Iseconds
      register: timestamp_result
      when: template_result.changed
      delegate_to: localhost
      run_once: true
        
    - name: Append timestamp to config file (only if config changed)
      lineinfile:
        path: "{{ playbook_dir }}/../configs/{{ inventory_hostname }}.cfg"
        regexp: "^#Config created via Jinja template on.*"
        line: "#Config created via Jinja template on {{ timestamp_result.stdout }}."
        insertafter: EOF
      when: template_result.changed
